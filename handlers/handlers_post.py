import requests
import os
from telegram import InlineKeyboardButton, InlineKeyboardMarkup

BOT_TOKEN = os.environ.get('BOT_TOKEN')
TELEGRAM_API_URL = f'https://api.telegram.org/bot{BOT_TOKEN}'

# –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user_states = {}

def handle_post_platform_selection(chat_id):
    text = "–í—ã–±–µ—Ä–∏, –∫—É–¥–∞ —Ö–æ—á–µ—à—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ—Å—Ç üëá"
    keyboard = [
        [InlineKeyboardButton("üì∏ Instagram", callback_data='post_instagram')],
        [InlineKeyboardButton("üó£ Telegram", callback_data='post_telegram')],
        [InlineKeyboardButton("üì¨ –°–ø–∞–º-—Ä–∞—Å—Å—ã–ª–∫–∞", callback_data='post_spam')],
        [InlineKeyboardButton("üì¢ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ", callback_data='post_vk')],
        [InlineKeyboardButton("üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é", callback_data='menu')]
    ]
    reply_markup = {'inline_keyboard': [[btn.to_dict() for btn in row] for row in keyboard]}

    requests.post(f'{TELEGRAM_API_URL}/sendMessage', json={
        'chat_id': chat_id,
        'text': text,
        'reply_markup': reply_markup
    })

def generate_platform_post(chat_id, platform):
    last_text = user_states.get(chat_id, {}).get('last_transcript')
    if not last_text:
        requests.post(f'{TELEGRAM_API_URL}/sendMessage', json={
            'chat_id': chat_id,
            'text': "‚ùå –ù–µ—Ç —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏. –°–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—é."
        })
        return

    if platform == 'instagram':
        text = f"üì∏ Instagram –ø–æ—Å—Ç:\n\n{last_text}\n\nüëâ –ù–∞–ø–∏—à–∏ –≤ –∫–æ–º–º–µ–Ω—Ç—ã, —á—Ç–æ –¥—É–º–∞–µ—à—å!"


{last_text}\n\nüëâ –ù–∞–ø–∏—à–∏ –≤ –∫–æ–º–º–µ–Ω—Ç—ã, —á—Ç–æ –¥—É–º–∞–µ—à—å!"

    elif platform == 'telegram':
        text = f"üó£ Telegram –ø–æ—Å—Ç:

{last_text}"

    elif platform == 'spam':
        preview = last_text[:300].strip()
        text = f"üì¨ –°–ø–∞–º-—Ä–∞—Å—Å—ã–ª–∫–∞:

**–ó–∞–≥–æ–ª–æ–≤–æ–∫:** {preview[:50]}...
**–¢–µ–∫—Å—Ç:** {preview}
[üìå –ü–æ–¥—Ä–æ–±–Ω–µ–µ](https://your-link.com)"

    elif platform == 'vk':
        text = f"üì¢ –ü–æ—Å—Ç –¥–ª—è –í–ö–æ–Ω—Ç–∞–∫—Ç–µ:

{last_text}\n\n#–∫–æ–Ω—Ç–µ–Ω—Ç #–±–æ—Ç #–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç"

    else:
        text = "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞"

    requests.post(f'{TELEGRAM_API_URL}/sendMessage', json={
        'chat_id': chat_id,
        'text': text
    })
